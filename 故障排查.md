# 故障排查指南

如果Discord或飞书没有收到推送，请按以下步骤排查：

## 1. 检查GitHub Secrets是否已设置

访问：https://github.com/waynegxxx/discord/settings/secrets/actions

确认以下Secret都已设置：
- ✅ `DISCORD_WEBHOOK` - Discord机器人Webhook地址（必需）
- ✅ `RSS_SOURCES` - RSS源配置（JSON格式，必需）
- ⚪ `FEISHU_WEBHOOK` - 飞书机器人Webhook地址（可选）

### RSS_SOURCES格式示例（重要！）

**✅ 正确格式：**
```json
[
  {
    "name": "网站名称1",
    "url": "https://example.com/rss"
  },
  {
    "name": "网站名称2",
    "url": "https://another-example.com/feed"
  }
]
```

**❌ 常见错误格式：**

1. **缺少方括号**（不是数组）：
```json
{
  "name": "网站名称",
  "url": "https://example.com/rss"
}
```
❌ 错误：必须是数组格式 `[...]`

2. **包含多余的大括号**：
```json
{
  "rss_sources": [
    {
      "name": "网站名称",
      "url": "https://example.com/rss"
    }
  ]
}
```
❌ 错误：直接使用数组，不要外层大括号

3. **引号使用错误**：
```json
[
  {
    'name': '网站名称',  // ❌ 单引号
    "url": "https://example.com/rss"
  }
]
```
❌ 错误：JSON必须使用双引号

4. **缺少逗号**：
```json
[
  {
    "name": "网站名称1",
    "url": "https://example.com/rss"
  }  // ❌ 缺少逗号
  {
    "name": "网站名称2",
    "url": "https://another-example.com/feed"
  }
]
```

5. **包含注释**：
```json
[
  {
    "name": "网站名称",
    "url": "https://example.com/rss"
    // ❌ JSON不支持注释
  }
]
```

### 如何验证JSON格式

1. **使用在线工具**：
   - https://jsonlint.com/
   - https://jsonformatter.org/
   - 将你的RSS_SOURCES内容粘贴进去验证

2. **使用Python验证**：
```python
import json
rss_sources = '[{"name": "测试", "url": "https://example.com/rss"}]'
json.loads(rss_sources)  # 如果格式正确不会报错
```

## 2. 检查GitHub Actions是否运行

1. 访问：https://github.com/waynegxxx/discord/actions
2. 查看最新的工作流运行记录
3. 点击进入查看详细日志

### 常见问题：

**问题：工作流没有运行**
- 检查是否设置了Secrets
- 手动触发：点击 "Run workflow" 按钮

**问题：工作流运行失败**
- 查看日志中的错误信息
- 常见错误：
  - `未设置 DISCORD_WEBHOOK` → 检查Secrets配置
  - `未设置 RSS_SOURCES` → 检查Secrets配置
  - `JSON格式错误` → 检查RSS_SOURCES的JSON格式（见下方详细说明）
  - `Expecting value: line X column Y` → JSON格式错误，检查第X行第Y列

### JSON格式错误详解

**错误信息：`Expecting value: line 9 column 4 (char 273)`**

这表示JSON格式有问题，位置在第9行第4列。

**解决方法：**
1. 复制你的RSS_SOURCES内容
2. 访问 https://jsonlint.com/ 验证格式
3. 确保：
   - 使用双引号（不是单引号）
   - 数组格式正确 `[...]`
   - 每个对象用逗号分隔
   - 没有多余的逗号
   - 没有注释

**示例修复：**

如果错误提示在第9行，可能是这样的问题：
```json
[
  {
    "name": "网站1",
    "url": "https://example.com/rss"
  },
  {
    "name": "网站2",  // ← 第9行，检查这里
    "url": "https://another.com/feed"
  }
]
```

检查：
- 第8行末尾是否有逗号
- 第9行的引号是否正确
- 是否有特殊字符需要转义

## 3. 测试飞书Webhook

### 方法一：使用测试脚本（本地）

```bash
# 安装依赖
pip install requests

# 运行测试脚本
python test_feishu.py
```

或者直接提供Webhook地址：
```bash
python test_feishu.py "你的Webhook地址"
```

### 方法二：使用curl命令

```bash
curl -X POST "你的Webhook地址" \
  -H "Content-Type: application/json" \
  -d '{
    "msg_type": "text",
    "content": {
      "text": "测试消息"
    }
  }'
```

### 方法三：在GitHub Actions中添加测试步骤

在 `.github/workflows/rss-monitor.yml` 中添加：

```yaml
- name: 测试飞书Webhook
  env:
    FEISHU_WEBHOOK: ${{ secrets.FEISHU_WEBHOOK }}
  run: |
    python test_feishu.py "$FEISHU_WEBHOOK"
```

## 4. 检查RSS源是否有效

### 测试RSS链接

在浏览器中打开RSS链接，确认：
- ✅ 链接可以正常访问
- ✅ 返回的是有效的RSS/XML格式
- ✅ 有最新的文章内容

### 常见RSS格式问题

- RSS链接可能已失效
- RSS链接需要登录才能访问
- RSS链接被墙（需要代理）

## 5. 检查是否是新文章

**重要**：脚本只会推送**新文章**，已推送过的文章不会重复推送。

### 首次运行
- 会推送RSS源中的最新文章（最多10条）
- 之后只会推送新发布的文章

### 重置推送记录

如果想重新推送所有文章，可以：
1. 删除 `rss_state.json` 文件（如果本地运行）
2. 或者在GitHub上删除该文件并提交

## 6. 查看详细日志

### 本地运行
直接运行脚本查看输出：
```bash
python rss_monitor.py
```

### GitHub Actions
1. 进入 Actions 页面
2. 点击最新的工作流运行
3. 展开 "运行RSS监控" 步骤
4. 查看详细日志输出

日志会显示：
- ✅ 配置检查结果
- ✅ RSS源检查情况
- ✅ 文章获取情况
- ✅ 推送成功/失败信息
- ❌ 错误详情

## 7. 常见错误及解决方案

### 错误：`未配置Discord Webhook地址` 或 `未配置飞书Webhook地址`
**原因**：配置文件或Secrets中没有Webhook地址
**解决**：
- 检查GitHub Secrets中的 `DISCORD_WEBHOOK`（必需）
- 检查GitHub Secrets中的 `FEISHU_WEBHOOK`（可选）

### 错误：`RSS_SOURCES JSON格式错误`
**原因**：RSS_SOURCES的JSON格式不正确
**解决**：
1. 使用在线JSON验证工具检查格式
2. 确保是数组格式：`[{...}, {...}]`
3. 确保使用双引号
4. 确保没有注释
5. 参考上面的正确格式示例

### 错误：`Process completed with exit code 128`
**原因**：Git操作失败，通常是权限问题
**解决**：
1. **检查工作流权限**：
   - 工作流已添加 `permissions: contents: write`
   - 如果仍然失败，检查仓库设置中的Actions权限

2. **如果是在提交状态文件时失败**：
   - 这是非关键步骤，不影响RSS监控功能
   - 工作流已设置 `continue-on-error: true`，不会影响整体运行
   - 状态文件提交失败不影响推送功能

3. **手动检查**：
   - 访问：https://github.com/waynegxxx/discord/settings/actions
   - 确保 "Workflow permissions" 设置为 "Read and write permissions"

4. **如果问题持续**：
   - 可以暂时禁用状态文件提交功能
   - RSS监控功能仍然正常工作，只是不会自动保存推送状态

### 错误：`推送失败: invalid webhook url`
**原因**：Webhook地址格式错误或已失效
**解决**：
1. 重新获取飞书机器人Webhook地址
2. 确认地址格式：`https://open.feishu.cn/open-apis/bot/v2/hook/...`

### 错误：`推送失败: rate limit exceeded`
**原因**：推送频率过高
**解决**：脚本已自动添加延迟，如果仍出现，可以增加延迟时间

### 错误：`RSS解析错误`
**原因**：RSS源格式有问题或无法访问
**解决**：
1. 在浏览器中测试RSS链接
2. 检查RSS链接是否需要特殊访问权限
3. 尝试使用其他RSS链接

### 错误：`HTTP状态码: 403` 或 `401`
**原因**：Webhook地址无效或已过期
**解决**：重新生成飞书机器人Webhook地址

## 8. 手动触发测试

### 在GitHub Actions中
1. 进入 Actions 页面
2. 选择 "RSS Monitor" 工作流
3. 点击 "Run workflow"
4. 选择分支（通常是main）
5. 点击 "Run workflow" 按钮

### 本地测试
```bash
# 确保有config.json文件
python rss_monitor.py
```

## 9. 验证推送成功

推送成功后，你应该在飞书群中看到：
- 📰 消息卡片格式
- 文章标题
- 发布时间
- 文章摘要
- "查看原文" 按钮

## 10. 联系支持

如果以上方法都无法解决问题，请：
1. 查看GitHub Actions的完整日志
2. 运行 `test_feishu.py` 测试Webhook
3. 检查RSS源是否正常
4. 提供错误日志信息

